# Talker-Thinker 交互测试记录（专项）

> 用于沉淀真实对话回放与问题定位，支撑后续系统性交互体验优化与回归验证。

## 2026-02-20 会话A：打车任务全双工回放

### 原始片段（节选）
```
[17:17:36.129] 你: 打车
[17:21:43.493] Talker: 好的！您可以通过滴滴、高德等App快速打车...

[17:21:44.539] 你: 详细对比下滴滴和高德打车的优劣势...
[17:22:28.553] Talker: 好的，这个问题需要深度思考，已转交给Thinker处理
[17:22:49.995] 你: 有点慢
⚠️ 上一任务已被用户打断
⚠️ 任务已取消
```

### 问题判定
1. **播报不足**：转交 Thinker 后在预处理阶段反馈不足，用户感知响应慢。  
2. **语义误判**：“有点慢”应属于 COMMENT/QUERY_STATUS，却被当作 REPLACE（取消）。

### 已落地修复
1. 在协作模式前置阶段新增播报：`正在同步上下文并规划步骤，请稍候...`。  
2. 意图分类中将“补充信息”检测提前，降低被新任务规则误伤概率。  
3. `_is_likely_new_task` 动作关键词移除过宽词项，避免“有点慢”类误判。  
4. Thinker 将阶段说明写入 SharedContext，Talker 可据此播报更贴近当前阶段内容。

### 回归用例（已补充）
- `test_slow_comment_should_not_cancel`  
- `test_supplement_should_be_modify`  
- `test_collaboration_handoff_returns_on_clarification`（补充前置播报断言）  
- `test_latest_shared_step_desc`

### 后续观察点
- 复杂任务转交后 1-4 秒内是否必有 Talker 状态反馈。  
- “取消/停止/算了”与“补充/另外/再加”语义边界在短文本下是否稳定。  
- Talker 播报内容是否能随 Thinker 阶段变化而更新（分析/规划/执行/整合）。

## 2026-02-20 会话B：选车任务异常回放

### 原始片段（节选）
```
[17:34:39] 用户: 推荐下怎么选车
[17:34:49] Talker: 已转交Thinker + 正在同步上下文...

[17:35:05] 用户: 感觉有点慢
[Talker] 抱歉让您久等了，正在加速处理...

[17:35:17] 用户: 还在吗
[Talker] 正在处理...已用时29秒

[17:35:30] 用户: 有啥信息没
[17:35:32] Talker: 方便说说您的购车预算吗？
[17:35:32] 用户: 30万
[17:35:37] Talker: 收到，已更新您的需求信息

[17:36:19] 用户: 不想打车了，定个餐馆
系统仅取消旧任务，未继续新意图
```

### 问题判定
1. **主动进度播报不稳定**：预检查阶段缺少持续播报。  
2. **Thinker可见度不足**：用户难以感知Thinker是否在推进。  
3. **输入语义处理不足**：状态查询与补充信息路径不够清晰。  
4. **取消+新意图未衔接**：复合输入只触发取消，未自动进入新任务。

### 本轮修复
1. 协作预检查阶段改为异步任务 + 5秒周期主动播报。  
2. 增加 IDLE 阶段播报模板，避免长时间只播报一次。  
3. `QUERY_STATUS` 引入 SharedContext 阶段/步骤/最新中间结果反馈。  
4. `MODIFY` 实时写入 SharedContext（约束与补充信息）并继续任务。  
5. 新增 `extract_replacement_input`，支持从“取消+新任务”复合语句提取新意图（如“定个餐馆”）。  
6. 修复交互循环：任务被取消后若存在新意图，立即启动下一任务。

### 本轮新增回归测试
- `test_status_phrase_should_be_query_status`
- `test_extract_replacement_input`
- `test_idle_stage_broadcast_template`

## 2026-02-20 会话C：记忆缺失与打断决策异常

### 原始片段（节选）
```
用户: 我的口味知道吗？
Talker: 不了解您的口味偏好...

用户: thinker没说话啊 / 完全没有播报进度 / 给我一些进度信息
Talker: 仅偶发状态回复，无稳定周期播报

用户: 吃饭的app
系统: 任务被打断并取消
```

### 问题判定
1. **跨会话记忆缺失**：已表达“喜欢吃辣”在新会话不可用。  
2. **Talker定期播报不稳定**：存在状态追问后才回，缺少固定心跳播报。  
3. **Thinker可见性低**：用户持续感知“Thinker没反应”。  
4. **打断治理不清晰**：补充信息“吃饭的app”被误走取消路径。

### 控制链路（当前实现）
1. **谁控制打断**：`main.py / TalkerThinkerApp.run_interactive` 在任务进行时接收新输入并调用 `_handle_new_input_during_processing`。  
2. **谁决策取消**：`TaskManager.classify_intent` 返回 `REPLACE` 后，`_handle_new_input_during_processing` 调用 `cancel_current_task()`。  
3. **为何会误取消**：当前规则对“短文本+话题词”仍可能偏向 `REPLACE`，复合语义（补充 vs 新任务）缺少二次确认与置信度门控。

### 重新规划的优化措施（vNext）
1. **跨会话记忆层（P0）**  
   - 新增用户偏好持久层（口味、预算、品牌偏好）并在新会话开场注入。  
   - 记忆写入触发：`MODIFY/澄清回答/显式偏好表达`。  
   - 记忆读取触发：问偏好、推荐类任务、餐饮/购车等垂域任务。

2. **播报可靠性层（P0）**  
   - 增加硬性心跳播报（例如每5-7秒）与“最后播报超时告警”。  
   - 播报降级策略：即使无新阶段，也要输出“仍在处理 + 当前阶段”。  
   - 对“用户催促后无播报”建立回归用例和指标。

3. **Thinker可见性层（P0）**  
   - 强制首反馈 SLA（转交后2秒内必须出现 Thinker/Talker阶段反馈）。  
   - 将 Thinker 阶段、步骤、最新中间结果结构化写入 SharedContext 并统一由 Talker播报。  
   - 针对澄清等待态，明确“等待你补充信息”状态提示，避免“无响应”感知。

4. **打断决策治理层（P0）**  
   - 引入三分决策：`CANCEL_ONLY / MODIFY_CURRENT / REPLACE_WITH_NEW_TASK`。  
   - 对 `REPLACE_WITH_NEW_TASK` 增加“新任务片段提取置信度”，低置信度时先追问确认。  
   - 对“吃饭的app”这类短补充默认归 `MODIFY_CURRENT`，除非包含明确取消/新任务触发词。

### 后续回归重点
- 跨会话口味记忆召回：新会话问“我的口味知道吗”应返回已知偏好。  
- 心跳播报稳定性：无用户追问时也应有周期播报。  
- 打断准确性：`吃饭的app` 不取消，`不想查了，改查餐馆` 应切换新任务。

## 2026-02-20 会话D：播报重复与上下文理解偏差

### 原始片段（节选）
```
[17:45:52] Talker: 已转交Thinker
[17:45:57] Talker: 仍在分析关键信息...
[17:46:02] Talker: 正在核对必要条件...
[17:46:07] Talker: 即将进入详细推理...
...（同类文案循环重复）

用户: 对比家具啊
Talker: 收到，继续处理「这个重复有点明显...」
（后续仍发起“请问想对比什么产品”澄清）
```

### 问题判定
1. **定时播报重复**：预检查模板循环，未与实际进度绑定。  
2. **上下文理解不准确**：用户已给“家具”方向，系统仍反问“对比什么”。  
3. **短补充句误路由**：如“对比家具啊”未被稳定识别为补充信息。

### 本轮P0实现
1. **预检查播报去重**  
   - 预检查阶段改为“前3条语义模板 + 后续按时间桶播报”，避免三句无限轮播。  
   - 预检查完成后输出规划信号：`Thinker已完成规划，预计N步执行`。

2. **播报与进度结合**  
   - Talker状态输出继续优先读取 SharedContext 的阶段/步骤/最近结果。  
   - 对无阶段变化场景使用时间桶模板，减少语义重复。

3. **上下文/意图修复**  
   - 增加“上下文补充短句”优先判定（`对比家具啊` → MODIFY）。  
   - 扩展主题提取（家具/应用），并将补充信息并入当前任务描述。  
   - 显式新任务（如`定个餐馆吧`）仍走 REPLACE，不影响切换能力。

4. **跨会话记忆P0落地（首版）**  
   - 增加全局偏好提取与持久化（如“喜欢吃辣”）。  
   - 将长期偏好注入 Talker 提示词，支持新会话记忆问答。

### 本轮新增回归测试
- `test_context_phrase_should_be_modify`
- `test_explicit_new_task_should_replace`
- `test_extract_user_preferences`
- `test_prompt_includes_user_preferences`

## 2026-02-20 会话E：Thinker无响应排查

### 原始现象
```
Talker持续播报“仍在分析/核对条件/即将推理...”
但长时间没有“Thinker: 开始处理”与Thinker正文输出
最终才再次出现澄清问题
```

### 根因
`_collaboration_handoff` 在进入 Thinker 主处理前，会先执行 precheck（`plan_task + needs_clarification`）。  
当 precheck 过慢时，流程被卡在 precheck 阶段，导致用户看到“Talker一直播报、Thinker不说话”。

### 本轮修复
1. 为 precheck 增加超时（`_precheck_timeout_s`，默认15秒）。  
2. precheck 超时后主动提示：`预分析耗时较长，先进入详细处理...`。  
3. 立即进入 Thinker 主处理，避免“无限前置播报”。  
4. 增加回归测试 `test_precheck_timeout_falls_back_to_thinker`，确保超时后仍会输出 `Thinker: 开始处理`。

## 2026-02-20 会话F：P0打断状态机落地

### 改动摘要
1. 在 `TaskManager` 增加中断动作决策：  
   - `CANCEL_ONLY`  
   - `MODIFY_CURRENT`  
   - `REPLACE_WITH_NEW_TASK`
2. 在 `_handle_new_input_during_processing` 中接入该决策：  
   - 纯取消（如“不买家具了”）只取消，不自动重启新任务。  
   - 取消+新任务（如“不买家具了，定个餐馆”）取消后自动切换新任务。

### 新增测试
- `test_interrupt_action_cancel_only`
- `test_interrupt_action_replace_with_new_task`

## 2026-02-20 会话G：P0播报质量与记忆召回补强

### 本轮优化
1. **播报质量**  
   - 协作播报新增“无进展抑制”：内容哈希不变且距离上次播报不足15秒时不重复播报。  
   - 保留“心跳播报”通道：长时间无进展时按阶段输出低频心跳，避免刷屏。

2. **跨会话记忆召回**  
   - 偏好提取扩展：支持口味、预算（如`20万`）、车型偏好（SUV/轿车）。  
   - 补充信息路径（MODIFY）也会触发偏好持久化，避免只在新请求时写入记忆。

### 新增测试
- `test_persist_user_preferences_budget`
- `test_should_broadcast_no_progress_then_heartbeat`

## 2026-02-20 会话H：通用记忆建模优化

### 问题
此前记忆提取主要依赖场景词（口味/预算/车型），泛化能力有限，难覆盖不同任务域。

### 本轮改进
1. 记忆提取从“场景硬编码”升级为“通用槽位建模”：  
   - `likes`（偏好项）  
   - `dislikes`（规避项）  
   - `constraints`（约束项）  
2. 保留高频兼容字段：`taste`、`budget`、`car_type`。  
3. 增加记忆合并策略：  
   - 列表字段去重并保序（避免覆盖历史偏好）  
   - 字典字段递归覆盖  
   - 标量字段按最新输入更新

### 价值
- 记忆能力不再强绑定单一场景，可迁移到餐饮、出行、购物、学习等不同任务域。  
- 用户多轮补充信息能形成逐步累积画像，而不是每轮重写。

### 新增测试
- `test_extract_user_preferences_generic_model`
- `test_merge_user_preferences_list_dedup`

## 2026-02-20 会话I：记忆建模与澄清协同

### 问题
即使已有偏好记忆，澄清阶段仍可能重复追问（如预算已知还问预算）。

### 本轮优化
1. Thinker 规划提示词注入通用偏好槽位（`user_preferences`）。  
2. 澄清判定增加“已知偏好覆盖过滤”：若缺失项已被记忆命中，则不再追问。  
3. 澄清问题生成也注入偏好上下文，减少与历史偏好冲突。

### 新增测试
- `test_planning_prompt_includes_preferences`
- `test_needs_clarification_respects_preferences`

## 2026-02-20 历史交互综合复盘（问题分类 + 优化方向 + 优先级）

### 一、核心问题分类（5大类）

1. **可见性与响应链路问题（P0）**  
   - 现象：Thinker“像没反应”，Talker长时间单边播报。  
   - 根因：precheck阻塞、阶段信号不稳定、首反馈缺少SLA约束。

2. **播报质量问题（P0）**  
   - 现象：有播报但重复明显，且与真实进度弱关联。  
   - 根因：模板轮播主导、阶段变化信号稀疏、去重维度不足（仅模板而非“阶段+语义+时间桶”）。

3. **意图理解与打断治理问题（P0）**  
   - 现象：补充信息被误判取消；“取消+新意图”衔接不稳。  
   - 根因：规则优先级与置信度门控不足，缺少三分决策状态机。

4. **上下文与记忆问题（P1）**  
   - 现象：用户已给上下文仍被反问；跨会话偏好召回不稳定。  
   - 根因：补充信息并入策略弱、任务语义摘要缺失、长期记忆写入/召回触发点不完整。

5. **评测与可观测性问题（P1）**  
   - 现象：问题反复出现，修复后稳定性难量化。  
   - 根因：缺少场景化回归门槛与线上质量指标闭环。

### 二、优化方向（按优先级）

#### P0（立即）
1. **响应链路SLA化**：转交后2秒内必须有Thinker可见反馈；precheck超时自动降级。  
2. **播报去重升级**：预检查播报改“有限模板+时间桶+阶段信号触发”，禁止循环刷屏。  
3. **打断状态机升级**：`cancel_only / modify_current / replace_with_new_task`，低置信度先确认。  
4. **补充信息并入强化**：短句补充（如“对比家具啊”）优先并入当前任务语义。

#### P1（近期）
1. **跨会话记忆闭环**：偏好写入、召回、注入统一化（含来源标记和TTL策略）。  
2. **上下文摘要中枢**：持续维护“当前任务语义摘要”，减少重复澄清。  
3. **质量指标上线**：播报重复率、Thinker首响应时延、误取消率、新意图切换成功率。

#### P2（中期）
1. **混合意图判定**：规则+轻量LLM双层判定并带置信度。  
2. **自适应播报**：根据任务复杂度/用户催促强度动态调节播报节奏与措辞。

### 三、建议执行顺序
1. 先稳链路（Thinker可见 + precheck超时）  
2. 再稳决策（意图三分与补充并入）  
3. 再提质量（播报去重与上下文一致性）  
4. 最后固化（跨会话记忆与评测门槛）
